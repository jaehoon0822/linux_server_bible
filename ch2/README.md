# 패키지 관리

<br />

## 패키지 관리 프로그램 RPM 사용

<br />

### RPM 패키지의 구성방식

<br />

> ***" RPM 패키지를 설치할 때 데이터 파일들은 리눅스의 파일 시스템에 설치되며 메타데이터는 /var/lib/rmp 에 저장돼 나중에 RPM 데이터 베이스로 사용된다. "***
>

<br />

| name | version | release | os | architecture | file type | 
| :---: | :---: | :---: | :---: | :---: | :---: | :---: |
| bind | 9.9.4 | 14 | e17 | x86\_64 | rpm |

<br />

### RPM 데이터베이스의 구조

<br />

> ***" ls /var/lib/rpm "*** 을 통해 나오는 파일중 Packages 파일이 제일 중요하다. 이 파일은 설치된 모든 RPM 파일의 메타데이터를 저장ㅎ나느 데이터베이스 파일로서 설치된 각 패키지가 색인 번호별로 정리된 패키지들에 대한 헤더의 태그 정보를 포함하고 있고, 시간이 지날수록 이 번호들은 천천히 증가하게 된다.
>

<br />

> Packages 파일을 제외한 나머지 파일들은 명령어 rpm --rebuilddb 를 통해 다시 생성이 가능하므로, Packages 파일을 안전한 장소에 백업해 둘것을 책에서는 추천한다.
>

<br />

### 명령어 rpm 을 이용한 패키지 관리

<br />

| 의미 | 단축옵션 | 옵션 |
| :--- | :--- | :--- | 
| 업그래이드/설치 | -U | --upgrade |
| 설치 | -i | --install |
| 삭제 | -e | --remove |
| 질의 | -q | --query |
| 검증 | -V | --verify |
| 서명 검사 | -K | --checksig |
| 업그레이드 | -F | --freshen |
| 데이터베이스 초기화 |  | --initdb |
| 데이터베이스 재생성 |  | --rebuilddb |
| 설치 정보 자세히 출력 | -v | --verbose |
| 해쉬 마크 출력 | -h | --hash |
| 이미 패키지가 설치돼 있는 경우 무시하고 재설치 | | --replacepkgs |
| 특정 파일이 충돌하는 경우 무시하고 재설치 | | --replacefiles |
| 무시하고 재설치 | | --force |
| 의존 관계 무시하고 제거 | | --nodeps |

<br />

> --replacepkgs 와 --replacefiles 는 -i 와 -U 를 사용했지만, 설치에 실패한 경우 사용하는 옵션이다.
>

<br />

> --replacepkgs 나 --replacefiles 를 사용하지 않고 --force 를 사용하여 무시하고 재설치 가능하다고 책에서 설명한다. 그냥 파일 충돌이나 패키지 충돌시 재설치 하고 싶다면 --force 를 써도 될것 같다.. 하지만 위의 2가지 옵션을 제거하는 이유가 있을 수도 있으니 기억해 두자..
>

<br />

> ***" -i 와 -U 의 차이점 -> -U 는 이미 하위 버전 패키지가 설치돼 있더라도 그것을 제거하고 새로 설치하거나 패키지가 설치돼 있지 않더라도 설치하라는 의미이다. -i 는 기존에 패키지가 설치되어 있지 않다면 설치하는 의미이다. ***"
>

<br />

> -e 옵션을 사용하여 패키지 제거가 가능하다. 하지만 의존관계로 인해 삭제가 안되는 경우가 존재한다. 이때 강제로 삭제하고 싶다면, --nodeps 옵션을 사용하여 제거한다. ( 의존 관계가 있다면 다른 어플리케이션에서 제거할 패키지를 사용하고 있다는 것이므로 이러한 경우 제거하지 않는것이 좋다. )
>

<br />

### 패키지 질의

<br />

> 여기서 헷갈릴 수 있는 옵션들이 있다. 분명 위에서 -i 는 --install 과 같다고 했지만, -q ( --qurery ) 와 함께 사용하면 --info ( infomation ) 과 같다. 이는 PACKAGE QUERY OPTIONS 이라 한다. 오직 -q 와 함께 쓰일때 쓰는 옵션이라 생각하면 된다.
>

<br />

| 옵션 | 설명 |
| :---: | :--- |
| -i | --info 패키지의 정보를 알려준다. |
| -l | --list 패키지가 어떤 디렉토리와 파일들을 파일 시스템에 설치했는지 보여준다. |
| --filesbypkg | --list 와 비슷하지만, 각 선택된 패키지안의 모든 파일 리스트를 보여준다. ( 표시방법이 다르다. ) |
| -f | 특정 파일이 어떤 패키지에 속해있는지 보여준다. |
| -R | --requires 해당 패키지를 설치하기 위해 시스템에 어떤 파일들이 필요한지 목록을 보여준다. |  
| --provides | 패키지의 버전 정보를 보여준다. |
| --scripts | 설치 전후, 제거될때 어떤 스크립트가 사용되는지 보여준다. |
| --changelog | 패키지가 어떤 과정을 거쳐 생성됐는지 모든 과정에 대한 변경 정보를 보여준다. |
| -a | --all 모든 인스톨된 패키지들을 질의한다. | 

<br />

### 패키지 검증( Verifying )

<br />

| 옵션 | 설명 |
| :--- | :--- |
| -V | --verify 패키지가 설치된 이후 이 패키지에 어떤 변화들이 있었는지 알기 위해 사용하는 옵션 | 

<br />

| 단어 | 설명 |
| :--- | :--- |
| S | Size 파일의 크기 변경을 의미 |
| 5 | MD5sum 의 약자. 각 파일의 변경 여부를 알려주는 체크섬의 값이 변경됐다는 의미, 보통 파일이 변경될때 마다 이 체크섬역시 변경된다. |
| T | Time 의 약어. 파일의 마지막 수정시간 |
| L | Symbolic Link 의 약어. 심복릭 링크가 변경된 경우 |
| D | Deivce 의 의미. Device 의 Major/Minor 번호가 변경된 경우 |
| U | User 의 의미. 파일 사용자의 소유권의 변경된 경우 |
| G | Group 의 의미. 파일 그룹의 소유권이 변경된 경우 |
| M | Mode 의 의미. 파일의 권한이나 타입이 변경된 경우 |
| ? | 읽을 수 없는 파일 |

<br />

### 패키지 서명 확인

<br />

| 옵션 | 설명 |
| :--- | :--- |
| -K | checksign 서명 정보 검사 |

<br />

서명 확인에 대해서는 잘 이해가 안가는 면이있다.   
rpm -qa gpg-pubkey\* 로 공개키 명령어 라는 것 같은데...   
내 터미널에서는 해당 정보가 나오지 않는다...   
그리고 해당 공개키에 대한 정보가 여러개인거 같은데,    
뭔가 감이 잡히지 않는다. 원래 공개키가 여러개인건가?    
일단 넘어가자...

<br />

### SRPM 다루기

<br />

> ***" SRPM( srouce RPM ) 파일을 다운로드해 RPM 바이너리 파일을 만들고, 또한 앞에서 배운 GPG 키를 이용해 서명한 다음 설치하는 과정이다. 총 6단계의 과정을 거치게 되는데, 각 단계별 설명은 다음과 같다. "***
>

<br />

#### 1단계 필수 패키지 설치

<br />

* RPM 바이너리 파일 생성을 위한 패키지들

<br />

> yum install rpm-build rpmlint rpmdevtools yum-utils -y
>

<br />

| 패키지 명 | 설명 |
| :--- | :--- |
| rpm-build | RPM 바이너리와 소스 RPM 파일을 패키징하기 위한 패키지 |
| rpminit | RPM 패키지의 문제를 검사하는 패키지 |
| rpmdevtools | RPM 패키지 개발에 필요한 여러 프로그램을 제공하는 패키지 |
| yum-utils | YUM 유틸리티 프로그램의 집합 패키지 |

<br />

#### 2단계 소스 파일 다운로드 

<br />

> yumdownloader --source ncftp
>

<br />

> yum-utils 의 yumdownloader 와 옵션 --source 를 사용해 srpm 을 다운 받는다.
>

<br />

#### 3단계 소스 파일 설치

<br />

> rpm -ivh ncftp-3.2.5-7.el7.src.rpm
>

<br />

#### 4단계 SPEC 파일 변경과 RPM 파일 만들기

<br />

> rpminit ncftp.spec   
	rpmbuild -ba ncftp.spec
>

<br />

> rpminit -> sepc 파일에 에러있는지 검사
>

<br />

> rpmbuild -ba -> RPM 바이너리 파일 생성
>

<br />

| 메크로 이름 | 디렉토리 이름 | 목적 |
| :---: | :--- | :--- |
| %\_specdir | ~/rpmbuild/SPECS | RPM SPEC( .spec ) 파일을 저장 |
| %\_sourcedir | ~/rpmbuild/SOURCES | 소스 패키지( 예: tarballs ) 와 패치 파일을 저장 |
| %\_builddir | ~/rpmbuild/BUILD | 소스 파일 압축이 풀려 컴파일이 이뤄지는 장소 |
| %\_buildrootdir | ~/rpmbuild/BUILDROOT | spec 파일의 %install 단계가 실행될때 파일들이 설치 되는 곳 |
| %\_rpmdir | ~/rpmbuild/RPMS | 바이너리 RPM 파일들이 저장되는 곳 |
| %\_srcrpmdir | ~/rpmbuild/SRPMS | 소스 RPM 이 생성돼 저장되는 곳 |

<br />

#### 5단계 RPM 파일에 GPG 서명 추가

<br />

> yum install gunpg2   
	gpg --gen-key
>

<br />

#### 6단계 바이너리 RPM 파일 설치 

<br />

> 
>

p96 ~ p105 까지 다시 읽어보자.. 사실 그렇게 확 와닿지 않는다. 뭔가 생소하고 외우는 느낌이라 이해로 접근이 잘 안된다.. 나중에 다른 책에서도 한번더 살펴봐야 겠다. 일단 넘기자.

<br />

## 패키지 관리 프로그램 YUM 사용

<br />

> ***" YellowDog Updater Modified 의 약어로서, RPM 의 치명적인 단점이라 할 수 있는 복잡한 패키지와 패키지 사이의 의존성 문제르 해결하기 위해 등장한 프로그램이다. "***
>

<br />

### YUM 작동 원리 이해 

<br />

| 단계 | 설명 |
| :---: | :--- |
| STEP 1 | YUM 설정 파일 /etc/yum.conf 확인 |
| STEP 2 | YUM 저장소 디렉토리 /etc/yum.repos.d/ 확인 |
| STEP 3 | YUM 저장소에서 패키지 다운로드 |
| STEP 4 | 리눅스 파일 시스템( /etc, /usr, /var ) 에 패키지 설치 | 
| STEP 5 | 메타데이터 RPM 데이터베이스 /var/lib/rpm 저장 |

<br />

#### /etc/yum.conf 

<br />

| 설정변수 | 값 |
| :--- | :--- |
| cachedir | 캐시 디렉토리 $basearch 는 CPU 아키텍쳐, $releasever 는 현재 릴리스 버전 번호를 의미 |
| keepchache | 패키지 설치 이후에 패키지와 헤더 파일의 캐시를 저장할 지 결정하는데, 숫자 0 은 No 의 의미로서 저장하지 않는다는 의미이다. |
| debuglevel | 디버깅 출력의 자세한 정도를 나타내는 숫자. 범위는 0( None ) 부터 10( All ) 까지다. |
| logfile | 패키지 설치에 대한 로그를 기록하는 파일의 이름 |
| exactarch | 패키지 설치 시 CPU 아키텍쳐와 일치하는 패키지를 선택할지 결정하는데. 숫자 1 은 Yes 를 의미한다. |
| obsoletes | yum update 실행 시 이전 버전의 패키지를 제거할지 결정한다. 숫자 1은 Yes 를 의미 |
| gpgcheck | GPG 키를 통한 패키지 검사를 허용할지 결정, 1 은 Yes 로서 모든 RPM 패키지를 설치 할때마다 그 패키지의 GPG 키를 확인한 다음 설치 |
| plugins | yum 기능 확장을 지원하는 플러그인을 사용할지 결정하는 숫자, 1 은 Yes 이며 사용한다는 의미이다. yum 플러그인의 기본 디렉토리는 /usr/lib/yum-plugins 이다. |
| installonly\_limit | installonlypkgs ( 설치만 허용하고 업데이트는 허용하지 않을 패키지 목록을 정의, 보통 커널을 사용함 ) 과 같이 사용되며, 이름은 같지만 버전 정보가 다른 패키지를 설치할 경우 몇 개 까지 허용할지 결정하는 숫자 |
| bugtracker\_url | yum 에 대한 버그를 정리해놓은 URL 을 의미, 보통 로컬 시스템 yum 저장소를 만들거나 특정 배포판별로 이러한 버그를 정리한다. |
| distroverpkg | 제공되는 패키지의 버전과 배포판의 이름을 의미, 현재 CentOS 의 패키지임을 나타낸다. |
| metadata\_expire | 각 저장소의 메타데이터는 기본적으로 90분 동안 xml 파일 형태로 각 저장소에 저장되는데, 만료 이후 명령어 yum 이 실행되면 이러한 메타데이터는 다시 저장소로부터 이 디렉토리에 저장된다. 명령어 yum 을 자주 사용하는 경우 이 시간을 더 늘려주는 것을 추천한다. | 

<br />

#### yum 저장소 디렉토리 /etc/yum.repos.d/ 

<br />

| 변수 이름 | 설명 |
| :--- | :--- |
| name | 저장소 파일 이름 |
| mirrorlist | 저장소들의 미러링 URL 목록을 정의 |
| baseurl | 기본이 되는 저장소 URL |
| gpgcheck | gpg 키 점검할지 의미, 1 은 Yes 를 의미, /etc/yum.conf 와 이 파일의 설정이 다른 경우 이 파일의 설정이 우선시 된다. |
| gpgkey | 패키지 검증에 필요한 공개키가 저장된 디렉토리 경로와 파일명 |

<br />

gpg key 생성 및 rpm 에 대해서는 더 살펴봐야 겠다. 잘 안 와닿는다. 

<br />

#### YUM 저장소에서 패키지 다운로드

<br />

> yum install blablabla
>

<br />

자세한건 책 p110 을 찾아보자.   
yum 을 사용해 봤다면 어렵지 않다.

<br />

#### 리눅스 파일 시스템 ( /etc, /usr, /var 등 ) 에 패키지 설치

<br />

> ***" 패키지를 다운로드해 설치하면 이 패키지는 리눅스 파일 시스템에 설치되는데, "***
>

<br />

| 저장 디렉토리 | 설명 |
| :--- | :--- |
| /etc | 일반적으로 패키지의 설정 파일을 저장 |
| /usr | 일반적으로 실행파일이나 문서를 저장 |
| /var | 일반적으로 패키지의 로그 및 데이터 파일등을 저장 |

<br />

#### 페키지의 메타데이터를 RPM 데이터베이스 /var/lib/rpm 에 저장

<br />

>
***" 각 패키지의 메타데이터를 RPM 의 데이터베이스인 /var/lib/rpm 에 저장하는데, 여기에 저장된 데이터베이스를 사용하는 명령어는 RPM 에서 query( q ) 나 yum info 패키지 이름을 통해 조회가능하다. "***
>

<br />

## 명령어 yum 이해

<br />

### 패키지 탐색과 조회

<br />

#### 패키지 탐색( search )

<br />

| 옵션 | 명령 |
| :--- | :--- |
| search | 패키지를 찾는다. |
| search all | 더 자세한 정보를 제공한다 |
| provides | 특정 패키지 이름은 모르지만 특정 파일을 알고 있고, 이 파일을 제공하는 패키지를 찾기 원하는 경우 이 옵션과 특정 파일의 경로를 입력하면 그 패키지를 찾을 수 있다. |

<br />

#### 패키지 설치 목록 보기( list )

> ***" search 옵션과 다른점은, list 는 단지 패키지의 이름에서만 일치된 단어를 찾기 때문에 search 에 비해 좀 더 제한적인 결과를 얻으므로 자세한 패키지 검색인 경우 search 를 사용할 것을 추천한다. "***
>

<br />

| 옵션 | 명령 |
| :--- | :--- |
| list all | 설치된 전체 패키지 목록과 설치 가능한 전체 패키지 목록을 알고 싶은 경우 list all 옵션을 사용 |
| list packageName\* | 특정 패키지의 설치 유무와 설치 가능여부를 확인 |
| list installed | 설치된 특정 패키지를 찾는경우 |
| list available | 현재 설치 가능한 패키지만 찾는 경우 |

<br />

#### repolist

<br />

> ***" 저장소 정보를 확인하기 위한 방법 "***
>

<br />

| 옵션 | 설명 |
| :--- | :--- |
| enable( default ) | 활성화된 저장소 목록을 찾는다. |
| disabled | 현재 사용하지 않은 저장소 목록을 알고 싶은 경우 |
| all | 전체 저장소 목록인 경우 |
| -v | --vervose 전체 저장소의 더 자세한 정보 |

<br />

| 명령어 | 설명 |
| :--- | :--- |
| repoinfo | 특정 저장소에 대한 정보 |

<br />

#### 패키지 정보 확인( info )

<br />

| 옵션 | 설명 |
| :--- | :--- |
| info | 패키지 정보를 확인하기 위한 방법 |
| deplist | 의존 관계에 있는 파일들의 목록과 그 파일이 속한 패키지 목록 |

<br />

| 명령어 | 설명 |
| :--- | :--- |
| yumdb info | 이미 설치된 패키지에 대한 정보만 제공 |

<br />

#### 패키지 설치( install )

<br />

| 옵션 | 설명 |
| :--- | :--- |
| install | 패키지 설치 |
| reinstall | 패키지 재설치 |
| insstall <경로> | 패키지 이름이 아니라 특정 경로에 있는 파일을 정의하면, 이 파일을 포함하고 있는 패키지를 설치 |

<br />

#### 패키지 제거( remove )

<br />

| 옵션 | 설명 |
| :--- | :--- |
| remove | 패키지 제거 |
| autoremove | 의존 관계에 있는 패키지 제거 |

<br />

#### 패키지 업데이트 ( update )

<br />

| 명령어 | 설명 |
| :--- | :--- |
| check-update | 업데이트 가능한 패키지 전체목록 |
| update | 패키지 업데이트 |
| group update | 특정 그룹의 패키지를 업데이트할 경우 group 옵션을 사용 |

<br />

| 옵션 | 설명 |
| :--- | :--- |
| --exclude=packageName | 특정한 패키지를 제외하고 업데이트 할 경우 |

<br />

#### 패키지 다운로드( download )

<br />

> 패키지를 설치하지 않고 다운로드만 할 경우
>

<br />

| 옵션 | 설명 |
| :--- | :--- |
| --destdir | 다운로드 받을 경로 설정 |

<br />

| 명령어 | 설명 |
| :--- | :--- |
| localinstall | 다운로드 받은 패키지 설치 |

<br />

#### 패키지 그룹 작업 ( group install )

<br />

p121 을 보자. 그룹화에 대한 내용이 애매하다. 그룹화에 대한 설명이 더 있으면 좋겠지만.. 왜 필요한지, 그룹화된 패키지가 어떤것인지, 환경 그룹 및 설치된 그룹, 설치 가능한 그룹 등등이 무엇인지 잘 이해가 안간다. 다른 리눅스 책을 더 살펴봐야 겠다.

<br />

#### YUM 트랜잭션 히스토리 작업 ( history )

<br />

> yum history 은 yum 명령어 트랜잭션에서 발생하는 모든 정보( 시간과 날짜, 영향을 미친 패키지의 숫자, 처리 과정의 성공 및 실패 등 ) 를 사용자에게 보여주는 역할을 한다. 
>

<br />

| 옵션 | 설명 |
| :--- | :--- |
| history or history list | 가장 최근 발생한 트랜젝션 20개를 선택해 보여준다. | 
| history all | 전체 트랜젝션 보기 |
| history list 1...5 | 옵션과 함께 ID 필드의 숫자만 입력하든지 아니면 그 숫자 처음과 끝, 그리고 그 사이 점을 이용해 지정한다. |

<br />

| ID | Login user | Date and time | Action(s) | Altered |
| :---: | :-----: | :-----------: | :-------- | :-----: |
| 각 트랜잭션 마다 고유되는 고유의 숫자 | 트랜잭션을 실행한 사용자의 이름 | 트랜잭션이 발생한 날짜와 시간 | 트랜잭션으로 인해 발생한 행동 | 트랜잭션에 의해 영향을 받은 패키지의 숫자 및 값들 |

<br />

| Action(s) 행동 | 설명 |
| :---: | :---: |
| D | 다운그레이드 |
| E | 삭제 |
| I | 설치 |
| O | ( Obsoleting ) 이전 버전 |
| R | 재설치 |
| U | 업데이트 |

<br />

| Altered 값 | 설명 |
| :---: | :---: |
| < | 트랜잭션이 마치기 전에 rpm 으로 이미 이 패키지에 대한 작업( 설치, 삭제 )을 했는데, yum 으로 인해 그 대이터가 rpmdb 에서 변경됐음을 의미 |
| > | 트랜잭션을 마친 후에 rpm 으로 이 패키지에 대한 작업( 설치, 삭제 )을 해서 rpmdb 가 변경됐음을 의미한다. 두 데이터베이스 간 동기화를 위해 명령어 yum history sync 를 사용해야 한다. |
| * | 트랜잭션이 성공적으로 마치지 못했음을 의미 |
| # | 트랜잭션은 성공했지만 yum 이 non-zero exit code 를 돌려준다. |
| E | 트랜잭션은 성공적이었지만 에러나 경고 메세지를 보여준다. |
| P | 트랜잭션은 성공적이었지만 이미 rpmdb 에 문제가 있었음을 의미 |
| s | 트랜잭션은 성공적이었지만 --skip-broken 옵션이 사용돼 일부 패키지는 설치가 생략 |

<br />

##### YUM 트랜잭션 통계와 특정 트랜잭션 정보 보기

<br />

| 옵션 | 설명 |
| :--- | :--- |
| history stats | YUM 트랜잭션 통계를 볼때 사용 | 
| history summary | yum 트랜잭션 요약 정보 |
| history package-list | 특정 패키지에 대한 히스토리 정보 |
| history info | 특정 ID에 대한 히스토리 정보 |

<br />

##### YUM 트랜잭션 되도리기와 재실행 

<br />

| 옵션 | 설명 |
| :--- | :--- |
| history undo ID | 되돌리기 |
| history redo ID | 재실행 |

<br />

##### 새로운 YUM 트랜잭션 시작

<br />

| 옵션 | 설명 |
| :--- | :--- |
| history new | 현재 트랜잭션을 중단하고 새로운 트랜잭션을 시작 |

<br />

p125 살펴보기. yum 트랜잭션에 대한 이해도가 없어서 명확히 이해가 가지 않는다. 다른 책에서도 살펴봐야겠다.

<br />

#### YUM 캐시 정보 관리

<br />

| 옵션 | 설명 |
| :--- | :--- |
| clean metadata | YUM 캐시 디렉토리의 각 저장소에 저장된 패키지의 메타데이터를 삭제, 메타데이터 대신 packages, headers, plugins 등을 사용할 수 없다. |
| clean all | 모든 캐시의 정보를 삭제 |
| clean rpmdb | RPM 데이터베이스에서 캐시된 데이터를 삭제 |
| makechache | 현재 활성화된 모든 저장소의 메타데이터를 생성하라는 의미, YUM 을 다시 이용할 경우 메타데이터를 저장소로부터 다시 다운로드할 필요가 없이 바로 패키지 설치가 진행되므로 시간을 단축 |

<br />

### YUM 유틸리티 프로그램 사용

<br />

> yum-utils 라는 패키지를 설치하면 그 외의 여러 명령어들을 사용할 수 있다.
>

<br />

| 옵션 | 설명 |
| :--- | :--- |
| yumdownloader | 특정 패키지를 로컬 시스템에 직접 다운로드 |
| package-cleanup --problems | 로컬 시스템에 설치된 RPM 파일중에서 의존성 문제를 갖고 있는 패키지 목록을 보여준다. |
| yum-config-manager | 기본 설정 내용을 보여준다. |
| yum-config-manager --add-repo | 웹 사이트상의 저장소를 직접 추가 |
| yum-complate-transaction | YUM 의 트랜잭션 작업 중 실패했거나 중단된 작업을 /var/lib/yum 에서 찾아서 완료시켜준다. |

<br />

## YUM 저장소 생성

<br />

> ***" 한 조직이나 회사 내에 많은 사용자가 RPM 패키지를 개별적으로 인터넷에서 다운로드하지 않고 한 로컬 저장소에서 모두 다운로드해 설치할 수 있다면 훨씬 효율적인 패키지 관리를 할 수 있다. "***
>

<br />





